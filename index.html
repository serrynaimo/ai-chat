<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./highlight.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.6/marked.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111111">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</script>
    <title>AI</title>
    <style>
        body {
            --width: calc(100vw - 20px);
            --max-width: 986px;
            --background-color: #080808bb;
            --offset: 0px;
            --content-box: #00000055;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #111;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(circle at center, #111111ee 0%, #111111f3 60%, #111111ff 100%), url(bg.jpg);
            
        }

        .standalone {
            --offset: 16px;
        }

        .aichat {
            position: relative;
            padding: 0 10px;
            width: var(--width);
            max-width: var(--max-width);
            margin: 0 auto;
            transition: width .7s ease-in-out;
        }

        header {
            position: fixed;
            z-index: 1;
            left: 0;
            right: 0;
            top: 0;
            background: linear-gradient(to bottom, #111 0%, var(--background-color) 100%);
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 25px #00000055;
        }

        .header {
            width: var(--width);
            max-width: var(--max-width);
            padding: 10px 10px 2px;
            margin: 0 auto;
            display: flex;
        }

        .header .menu-container {
            display: flex;
            gap: 5px;
            flex: 1;
        }

        .header .menu-container:last-child {
            justify-content: flex-end;
        }

        .header h1 {
            color: #ddd;
            margin: 0;
            font-size: 1.8em;
            transition: transform .5s ease-in-out;
            text-shadow: 0 5px 25px rgba(0, 0, 0, .5);
        }

        .header button {
            background: transparent;
            border: 0;
            border-radius: 25px;
            cursor: pointer;
            color: #ddd;
            font-size: .85em;
            gap: 5px;
            flex-wrap: nowrap;
            padding: 5px 3px;
            display: inline-flex;
            align-items: center;
        }

        .menus {
            position: fixed;
            top: 0;
            --max-width: 986px;
            left: calc(calc(max(100vw, var(--max-width)) - var(--max-width)) / 2);
            width: 100vw;
            max-width: calc(var(--max-width) + 20px);
            margin: 0;
            z-index: 2;
        }

        .menu {
            position: absolute;
            top: 49px;
            left: 0px;
            width: min(var(--width), 380px);
            padding: 10px 10px 0;
            display: none;
            background: var(--background-color);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px #00000055;
            height: fit-content;
            max-height: calc(100dvh - calc(59px + var(--offset)));
            overflow: hidden;
            overflow-y: auto;
        }

        @media (max-width: 680px) {
            .header button span {
                display: none;
            }
        }

        @media (max-width: 1008px) {
            .menu {
                height: calc(100dvh - calc(59px + var(--offset)));
            }
        }

        @media (min-width: 1340px) {
            .chat-container .chat-messages {
                padding: 0 100px;
            }

            .header .history-button, .header .settings-button {
                display: none;
            }

            .menus {
                width: auto;
                left: 0;
                margin: 0;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                box-shadow: 0 5px 25px #00000055;
                background: linear-gradient(to bottom, #111 0%, var(--background-color) 100%);
                overflow: hidden;
                opacity: 0;
                transform: translateX(-150px);
                transition: all .3s ease-out;
            }

            .menu {
                position: relative;
                top: 0;
                left: 0;
                display: block;
                width: 300px;
                border: 0;
                flex: 1;
                margin: 0;
                box-shadow: none;
                background: none;
                max-height: none;
                opacity: .4;
                transition: opacity .3s linear;
            }

            .menu:hover,
            .menus:hover {
                opacity: 1;
                transform: translateX(0);
            }

            .menu + .menu {
                flex: 0 0 fit-content;
                border-top: 1px solid #222;
                max-height: 50vh;
            }
        }

        .menu.open {
            display: block;
        }
        
        .menu > div:not(:empty) + div:not(:empty) {
            margin-top: 16px;
        }

        .menu h4 {
            color: #444;
            margin: 4px 0 0;
            font-weight: normal;
        }

        .menu button {
            background: transparent;
            border: 0;
            cursor: pointer;
            color: #ddd;
            font-size: 1em;
            margin: 20px 0;
            padding: 0 8px;
            display: block;
            text-align: left;
            max-height: 3.54em;
            border-radius: 0;
            width: 100%;
            overflow: hidden;
        }

        .menu button#clearHistory {
            font-style: italic;
            border-top: 1px solid #222;
            margin: 8px 0 0;
            padding: 16px 8px 16px 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ddd' aria-hidden='true'%3E%3Cpath d='M16 6V4.5C16 3.12 14.88 2 13.5 2h-3C9.11 2 8 3.12 8 4.5V6H3v2h1.06l.81 11.21C4.98 20.78 6.28 22 7.86 22h8.27c1.58 0 2.88-1.22 3-2.79L19.93 8H21V6h-5zm-6-1.5c0-.28.22-.5.5-.5h3c.27 0 .5.22.5.5V6h-4V4.5zm7.13 14.57c-.04.52-.47.93-1 .93H7.86c-.53 0-.96-.41-1-.93L6.07 8h11.85l-.79 11.07zM9 17v-6h2v6H9zm4 0v-6h2v6h-2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 4px center;
            background-size: 20px;
        }

        .menu input {
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding: 5px 8px 4px;
            margin: 8px 0 10px;
            background: #333333cc;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 16px;
            outline: none;
            color: #eee;
            font-family: inherit;
            line-height: 20px;
        }

        .menu input:focus {
            background: #444444cc;
        }

        .menu textarea {
            padding: 5px 8px 4px;
            margin: 8px 0 0;
        }

        #historyMenu:before {
            display: block;
            content: 'History';
            color: #444;
            margin: 4px 0 -4px;
        }

        #historyMenu:empty:before {
            content: 'Your history is empty.';
            font-style: italic;
        }

        #historyMenu {
            left: auto;
            right: 0px;
        }

        #modelSection:not(:empty):before {
            display: block;
            content: 'Models';
            color: #444;
            margin: 4px 0 -4px;
        }

        #modelSection button:not(.checked) {
            padding-left: 30px;
        }

        #modelSection button.checked:before {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            margin: -2px 8px -2px -2px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ddd' d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 16px;
        }

        .chat-container {
            max-width: var(--max-width);
            margin: 40px auto calc(88px + var(--offset));
            width: var(--width);
            min-height: calc(100dvh - calc(130px + var(--offset)));
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            justify-content: flex-end;
        }

        .chat-messages {
            padding: 1em 4px 4px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            transition: transform .4s ease-out, padding .2s linear;
        }

        .message {
            width: fit-content;
            max-width: 85%;
            padding: 0 1em;
            border-radius: 5px;
            margin-top: .5em;
            animation: load .5s ease-in-out 1;
        }

        .user-message {
            margin-top: 3em;
            background-color: #1f87cd;
            color: #eee;
            cursor: pointer;
            --background: rgba(0, 0, 0, .1);
            box-shadow: 0 5px 25px #00000033;
        }

        .user-message .attachments {
            margin: 1em 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 4px;
        }

        .ai-message {
            color: #aaa;
            max-width: 100%;
            line-height: 1.5em;
            padding: 0;
        }

        .system-message {
            line-height: 1.5em;
            font-style: italic;
            padding: 0 0 0 28px;
            color: #777;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='16' height='16' aria-hidden='true'%3E%3Cpath fill='%23777' d='M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM11 7h2v2h-2V7zm0 4h2v6h-2v-6z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 47%;
            background-size: 20px;
        }

        .input-container {
            position: fixed;
            z-index: 1;
            bottom: -4px;
            padding: 10px 10px var(--offset);
            margin: 0 -10px;
            max-width: var(--max-width);
            width: var(--width);
            --background: #222;
            transition: transform .4s ease-out, width .7s ease-in-out;
            animation: load 1s ease-in-out 1;
        }

        .input-container button#scrolldown {
            position: absolute;
            display: none;
            right: 14px;
            top: -36px;
            border: 0;
            background-color: #262626;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 20' width='16' height='16'%3E%3Cpath stroke='%23888' fill='transparent' stroke-width='4' d='M2.000,5.000 L15.000,18.000 L28.000,5.000' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 16px 16px;
            width: 32px;
            height: 32px;
            box-shadow: 0 -2px 25px #00000055;
            border-radius: 16px;
            cursor: pointer;
        }

        .embedded .input-container,
        .standalone .input-container {
            display: block;
        }

        @keyframes load {
            0%, 60% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        textarea {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #444;
            background: #333333ee;
            backdrop-filter: blur(10px);
            border-radius: 5px;
            font-size: 16px;
            outline: none;
            color: #eee;
            resize: none;
            font-family: inherit;
            line-height: 20px;
        }

        textarea:focus {
            background: #444444cc;
        }

        textarea::placeholder {
            color: #aaa;
        }

        .input-container textarea {
            padding: 10px 40px 60px 32px;
            box-shadow: 0 5px 25px #00000055;
            border-radius: 5px 5px 0 0;
            min-height: 98px;
            max-height: 45vh;
            overflow-y: hidden;
            margin-bottom: -20px;
        }

        .input-container .attachments {
            position: absolute;
            z-index: 3;
            bottom: calc(10px + var(--offset));
            padding: 0;
            left: 14px;
            right: 14px;
            display: flex;
            gap: 4px;
            overflow: hidden;
            overflow-x: scroll;
        }

        .attachment {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 6px;
            border-radius: 3px;
            min-width: 44px;
            max-width: 200px;
            overflow: hidden;
            color: rgba(255, 255, 255, .8);
            background: var(--background);
        }

        .attachment .type {
            color: #d7ba7d;
            font-size: 7px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .attachment .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
        }

        .attachment button {
            display: none;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 0;
            font-size: 18px;
            line-height: 14px;
            position: relative;
            top: -1px;
        }

        .input-container .attachment button {
            display: block;
        }

        #fileInput {
            display: none;
        }

        #addFiles {
            position: absolute;
            left: 14px;
            top: 17px;
            height: 24px;
            width: 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ddd' d='M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 20px;
        }

        button#ask {
            position: absolute;
            right: 14px;
            top: 14px;
            box-sizing: border-box;
            width: 32px;
            height: 34px;
            background-color: #1f87cd;
            color: #eee;
            border: none;
            font-size: 16px;
            border-radius: 3px;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' aria-hidden='true'%3E%3Cpath fill='%23ddd' d='M12 3.586L19.46 11.043l-1.42 1.414L13 7.414V21h-2V7.414L5.96 12.457l-1.42-1.414L12 3.586z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 22px;
        }

        button#ask.stop {
            background-color: #db3434;
            background-size: 18px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24' aria-hidden='true'%3E%3Cpath fill='%23ddd' d='M6 5h12v14H6z'/%3E%3C/svg%3E");
        }

        button#ask:disabled {
          background-color: #777;
        }

        .status {
            line-height: 20px;
            align-self: stretch;
            color: rgba(255, 255, 255, .2);
            font-size: .85em;
            opacity: .5;
            white-space: nowrap;
            overflow: hidden;
            overflow-x: auto;
            opacity: 1;
            transition: all .3s ease-out;
            height: 24px;
        }

        p:empty,
        p > br:first-child,
        .status:empty {
            display: none;
        }

        think,
        .think {
          display: block;
          font-size: 13px;
          line-height: 16px;
          color: #777;
          padding: 10px 0;
          border-radius: 5px;
          overflow: hidden;
          max-height: 17px;
          margin: 10px 0;
          position: relative;
        }

        .think {
            cursor: pointer;
        }

        think:after,
        .think:after {
            content: "";
            position: absolute;
            top: .7rem;
            left: 1px;
            width: 16px;
            height: 16px;
            transform: rotate(-90deg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='16' height='16' aria-hidden='true'%3E%3Cpath fill='%23888' d='M3.543 8.96l1.414-1.42L12 14.59l7.043-7.05 1.414 1.42L12 17.41 3.543 8.96z'%3E%3C/path%3E%3C/svg%3E");
        }

        think,
        .think.expanded {
            max-height: fit-content;
        }

        think:after,
        .think.expanded:after {
            transform: rotate(0deg);
        }

        think:before,
        .think:before {
          content: "Thinking ...";
          display: block;
          color: #888;
          font-size: 1rem;
          font-style: italic;
          padding: 2px 0 6px 20px;
        }

        think + p + think:before,
        .think + p + think:before,
        .think + p + .think:before {
          content: "Considering additional information ...";
        }

        think:before {
            padding-bottom: 12px;
        }

        think > p:last-child,
        .think > p:last-child {
            margin-bottom: 0px;
        }

        .code {
            background-color: var(--content-box);
            border-radius: 5px;
            margin: 1em 0;
        }

        .meta {
            border-top: 1px solid #333;
            font-size: 13px;
            color: #888;
            display: flex;
            justify-content: space-between;
            padding: 10px 1em;
        }

        .meta button.copy {
            background-color: transparent;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='16' height='16' aria-hidden='true'%3E%3Cpath fill='%23888' d='M19.5 2C20.88 2 22 3.12 22 4.5v11c0 1.21-.86 2.22-2 2.45V4.5c0-.28-.22-.5-.5-.5H6.05c.23-1.14 1.24-2 2.45-2h11zm-4 4C16.88 6 18 7.12 18 8.5v11c0 1.38-1.12 2.5-2.5 2.5h-11C3.12 22 2 20.88 2 19.5v-11C2 7.12 3.12 6 4.5 6h11zM4 19.5c0 .28.22.5.5.5h11c.28 0 .5-.22.5-.5v-11c0-.28-.22-.5-.5-.5h-11c-.28 0-.5.22-.5.5v11z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center right;
            background-size: contain;
            width: fit-content;
            min-width: 16px;
            height: 16px;
            padding-right: 21px;
            border: none;
            cursor: pointer;
        }

        .meta button.copy:before {
            content: 'Copied!';
            opacity: 0;
            font-style: italic;
            color: #777;
            transition: all 1s ease-out;
        }

        .meta button.copy:active:before {
            opacity: 1;
            transition: none;
        }

        ul {
            margin-top: .5em;
        }

        li {
            margin-bottom: .5em;
        }

        pre {
            display: block;
            overflow: hidden;
            overflow-x: auto;
            margin-bottom: 0;
        }

        code {
            padding: .18em .34em;
            border-radius: 5px;
            background: var(--content-box);
            color: #d7ba7d;
            font-size: 1em;
        }

        pre > code {
            display: block;
            background: transparent !important;
            padding: 1em;
        }

        a {
            color: #3498db;
        }

        blockquote {
            border-radius: 5px;
            background: var(--content-box);
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            font-style: italic;
            font-size: 1.1em;
            padding: .4em 1.4em;
            margin: 1em 0;
            color: #ddd;
        }

        p {
            margin: 1em 0;
        }

        .table {
            overflow: hidden;
            overflow-x: auto;
            margin: 1em 0;
            max-width: 100%;
            width: fit-content;
            border-radius: 5px;
            background: var(--content-box);
        }

        table {
            border-spacing: 0;
        }

        th {
            border-bottom: 1px solid #333;
            padding: .4em .6em;
        }

        td {
            padding: .4em .6em;
        }

        hr {
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, .1);
            margin: 2em 0;
        }

        h1, h2, h3, h4, h5, h6 {
            margin: 1.6em 0 1em;
            line-height: 1.35em;
            color: #ddd;
        }

        b, strong {
            color: #ddd;
        }

        .katex-display {
            margin: 1em 0;
            padding: 12px;
            border-radius: 5px;
            background: var(--content-box);
            overflow: hidden;
            overflow-x: auto;
        }

        footer {
            position: absolute;
            margin: 0 auto;
            z-index: 0;
            opacity: 0;
            width: 400px;
            left: 50%;
            margin: 0 -200px;
            bottom: 50px;
            color: rgba(255,255,255,.2);
            text-align: center;
            font-size: .8em;
            animation: load 1.6s ease-in-out 1;
        }

        footer a {
            color: rgba(255,255,255,.2);
        }

        .new {
            --centering: calc(-55vh + 120px);
        }
        
        .new .aichat {
            --max-width: 680px;
            --width: calc(min(var(--max-width), 100vw) - 20px);
            transform-origin: 50% 100%;
        }

        @media (min-height: 600px) {
            .new .header h1 {
                transform: translateY(calc(25vh - 80px)) scale(3.5);
            }
        }

        .new .input-container {
            transform: translateY(var(--centering));
        }

        .new .input-container textarea {
            border-radius: 5px;
            margin-bottom: 2px;
        }

        .new .chat-messages {
            padding: 0 33px;
            transform: translateY(calc(var(--centering) - 10px));
        }

        .new .message {
            border: none;
        }

        .new .status {
            opacity: 0;
            transform: translateY(var(--centering));
            margin-top: -22px;
        }

        .new button#scrolldown {
            display: none !important;
        }

        .new footer {
            opacity: 1;
            transition: opacity .5s ease-in-out;
        }
    </style>
</head>
<body class="new">
    <header>
        <div class="header">
            <div class="menu-container">
                <button class="settings-button" onclick="openMenu('settingsMenu')" title="Set server settings and model">
                    <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true"><path fill="#ddd" d="M10.54 1.75h2.92l1.57 2.36c.11.17.32.25.53.21l2.53-.59 2.17 2.17-.58 2.54c-.05.2.04.41.21.53l2.36 1.57v2.92l-2.36 1.57c-.17.12-.26.33-.21.53l.58 2.54-2.17 2.17-2.53-.59c-.21-.04-.42.04-.53.21l-1.57 2.36h-2.92l-1.58-2.36c-.11-.17-.32-.25-.52-.21l-2.54.59-2.17-2.17.58-2.54c.05-.2-.03-.41-.21-.53l-2.35-1.57v-2.92L4.1 8.97c.18-.12.26-.33.21-.53L3.73 5.9 5.9 3.73l2.54.59c.2.04.41-.04.52-.21l1.58-2.36zm1.07 2l-.98 1.47C10.05 6.08 9 6.5 7.99 6.27l-1.46-.34-.6.6.33 1.46c.24 1.01-.18 2.07-1.05 2.64l-1.46.98v.78l1.46.98c.87.57 1.29 1.63 1.05 2.64l-.33 1.46.6.6 1.46-.34c1.01-.23 2.06.19 2.64 1.05l.98 1.47h.78l.97-1.47c.58-.86 1.63-1.28 2.65-1.05l1.45.34.61-.6-.34-1.46c-.23-1.01.18-2.07 1.05-2.64l1.47-.98v-.78l-1.47-.98c-.87-.57-1.28-1.63-1.05-2.64l.34-1.46-.61-.6-1.45.34c-1.02.23-2.07-.19-2.65-1.05l-.97-1.47h-.78zM12 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5c.82 0 1.5-.67 1.5-1.5s-.68-1.5-1.5-1.5zM8.5 12c0-1.93 1.56-3.5 3.5-3.5 1.93 0 3.5 1.57 3.5 3.5s-1.57 3.5-3.5 3.5c-1.94 0-3.5-1.57-3.5-3.5z"></path></svg>
                    <span>Settings</span>
                </button>
            </div>
            <h1>AI</h1>
            <div class="menu-container">
                <button class="history-button" onclick="openMenu('historyMenu')" title="Open chat history">
                    <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true"><path fill="#ddd" d="M12 4C9.25 4 6.83 5.39 5.38 7.5H8v2H2v-6h2V6c1.82-2.43 4.73-4 8-4 5.52 0 10 4.48 10 10s-4.48 10-10 10c-4.76 0-8.74-3.33-9.75-7.78l1.95-.44C5.01 17.34 8.19 20 12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8zm-1 4h2v3.59l3.21 3.2-1.42 1.42-3.79-3.8V8z"></path></svg>
                    <span>History</span>
                </button>
                <button class="new-button" onclick="startNew()" title="Start a new chat">
                    <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true"><path fill="#ddd" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
                    <span>New Chat</span>
                </button>
            </div>
        </div>
    </header>
    <div class="aichat">
        <div class="menus">
            <div class="menu" id="historyMenu"></div>
            <div class="menu" id="settingsMenu">
                <div id="modelSection"></div>
                <div>
                    <h4>Server</h4>
                    <input type="text" id="API_URL" placeholder="API URL" autocorrect="off" data-default="http://localhost:1234" onblur="saveSetting('API_URL')" class="setting" />
                    <input type="text" id="API_KEY" placeholder="API key" autocorrect="off" autocomplete="off" data-default="lm-studio" onblur="saveSetting('API_KEY')" class="setting" />
                </div>
                <div>
                    <h4>System prompt</h4>
                    <textarea rows="3" id="SYSTEM_PROMPT" placeholder="How should the AI behave exactly?" data-default="Comply with the user as best you can and choose to be the role or character most appropriate to answer the given query. Use a mildly cynical yet warm attitude. Use tools to refine your knowledge or take action and ask for more details or clarification for very complex queries. Consider fun and relatability in the way you assemble your final answer to enhance their readability and better understanding. Be a little entertaining." onblur="saveSetting('SYSTEM_PROMPT')" class="setting"></textarea>
                </div>
                <div>
                    <h4>About you</h4>
                    <textarea rows="3" id="USER_INFO" placeholder="Who and where are you, what should the AI know? Celsius or Fahrenheit? km/h or mph?" data-default="" onblur="saveSetting('USER_INFO')" class="setting"></textarea>
                </div>
                <div>
                    <h4>Google Custom Search</h4>
                    <input type="text" id="GOOGLE_CUSTOMSEARCH_API_KEY" placeholder="Google Custom Search API key" autocorrect="off" data-default="" onblur="saveSetting('GOOGLE_CUSTOMSEARCH_API_KEY')" class="setting" />
                    <input type="text" id="GOOGLE_CUSTOMSEARCH_ENGINE_ID" placeholder="Google Custom Search Engine ID" autocorrect="off" autocomplete="off" data-default="" onblur="saveSetting('GOOGLE_CUSTOMSEARCH_ENGINE_ID')" class="setting" />
                </div>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <footer>
                A project by <a href='https://github.com/serrynaimo/ai-chat' target='_blank' rel='noopener'>Thomas Gorissen</a> - MIT License
            </footer>
        </div>
        <div class="input-container">
            <div class="attachments" id="fileAttachments"></div>
            <textarea id="userInput" placeholder="What's on your mind ..." rows="1" onfocus="adjustOffset('0px')" onblur="adjustOffset()"></textarea>
            <input type="file" id="fileInput" accept=".pdf,.txt,.csv,.tsv,.js,.json,.jsx,.ts,.tsx,.css,.scss,.less,.html,.htm,.xml,.yaml,.yml,.md,.py,.rb,.java,.c,.cpp,.h,.hpp,.cs,.php,.sql,.sh,.bash,.zsh" multiple>
            <button id="addFiles" onclick="document.getElementById('fileInput').click()" title="Attach PDF or Text files"></button>
            <button id="ask" onclick="sendMessage()" disabled title="Start/stop answer generation"></button>
            <button id="scrolldown" onclick="window.scrollTo(0, document.documentElement.scrollHeight)"></button>
        </div>
    </div>
    <script>
        // Configuration
        const DEFAULT_MODELS = ['llama-3.2-3b-instruct', 'grok-2-1212']; // Use a non-reasoning very fast conversation model
        const MAX_TOKENS = 20000;
        const TEMPERATURE = 0.7;
        const MAX_STORAGE_CHARS = 5242880; // 5MB character limit for localStorage
        const DEFAULT_GREETING = 'Howdy, is it time to help again?';

        const TOOLS = [{
            type: "function",
            function: {
                name: "render_equations",
                description: "Call this tool before you start rendering math equations in KaTeX to allow them to render nicely.",
                parameters: {
                    type: "object",
                    properties: {}
                },
            }
        }, {
            type: "function", 
            function: {
                name: "search_web_info",
                description: "Search the web for current information about a topic. Only use when asked about current events or specific information that need verification.",
                parameters: {
                    type: "object",
                    properties: {
                        query: {
                            type: "string",
                            description: "The search query or keywords"
                        }
                    },
                    required: ["query"]
                }
            }
        }, {
            type: "function",
            function: {
                name: "get_current_time",
                description: "Get the current time and/or date, only if asked",
                parameters: {
                    type: "object",
                    properties: {}
                },
            }
        }, {
            type: "function",
            function: {
                name: "get_weather",
                description: "Retrieve the current or 7-day forecasted weather information at a specific latitude and longitude, only if asked",
                parameters: {
                    type: "object",
                    properties: {
                        latitude: {
                            type: "number",
                            description: "The exact latitude of the location on planet earth"
                        },
                        longitude: {
                            type: "number",
                            description: 'The exact longitude of the location on planet earth'
                        },
                        temp_unit: {
                            type: "string",
                            description: "Unit the temperature will be returned in",
                            enum: ['fahrenheit', 'celsius']
                        },
                        speed_unit: {
                            type: "string",
                            description: "Unit the wind speed will be returned in",
                            enum: ['kmh', 'mph']
                        },
                        forecast: {
                            type: "boolean",
                            description: "False returns the current weather. True the 7-day forecast."
                        }
                    },
                    required: ["latitude", "longitude", "forecast"]
                },
            }
        }, {
            type: "function",
            function: {
                name: "get_user_history",
                description: "Retrieve the user history containing what you and the user previously talked about. Use it if prompted to or if necessary to personalise or find additional context from past conversations",
                parameters: {
                    type: "object",
                    properties: {
                        keywords: {
                            type: "string",
                            description: "A white-space separated list of keywords that can help find a relevant content. If empty it will return the last 5 chat logs."
                        },
                        limit: {
                            type: "number",
                            description: `Maximum number of chat logs to return. Each chat log can be about ${MAX_TOKENS} characters to parse and process.`
                        }
                    }
                },
            }
        }]

        // TOOL FUNCTIONS
        async function render_equations() {
            const style = document.createElement('link')
            style.rel = 'stylesheet'
            style.href = 'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css'
            style.crossOrigin = 'anonymous'
            document.head.appendChild(style)

            const script = document.createElement('script')
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js'
            script.crossOrigin = 'anonymous'
            document.head.appendChild(script)
            
            return await new Promise(resolve => script.onload = () => resolve('I\'m now ready to receive your KaTeX formulas and make them look pretty.'))
        }

        async function search_web_info({ query }) {
            try {
                if (!query.trim()) {
                    throw new Error('No query or keywords provided. Try again?')
                }
                const response = await fetch(
                    `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_CUSTOMSEARCH_API_KEY}&cx=${GOOGLE_CUSTOMSEARCH_ENGINE_ID}&q=${encodeURIComponent(query)}`
                )
                if (response.status === 403) {
                    throw new Error('Please tell the user that they have not set up their Google Custom Search key in the source code, yet.')
                }
                if (!response.ok) {
                    throw new Error(data.error?.message)
                }
                const data = await response.json()  
                return {
                    query,
                    results: data.items.map(i => ({ title: i.title, snippet: i.snippet, link: i.link }))
                }
            } catch (e) {
                return {
                    error: 'Failed to provide search results', 
                    details: e.message
                }
            }
        }

        async function get_weather({ latitude, longitude, speed_unit = 'kmh', temp_unit = 'celsius', forecast = true }) {
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}`
                + (forecast
                    ? '&daily=temperature_2m_max,temperature_2m_min,relative_humidity_2m_mean,weather_code,wind_speed_10m_max,wind_direction_10m_dominant&forecast_days=7'
                    : '&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m')
                + `&wind_speed_unit=${speed_unit}&temperature_unit=${temp_unit}`)
            const data = await response.json()
            
            // Map weather codes to descriptions
            const weatherCodes = {
                0: 'Clear sky',
                1: 'Mainly clear', 
                2: 'Partly cloudy',
                3: 'Overcast',
                45: 'Foggy',
                48: 'Depositing rime fog',
                51: 'Light drizzle',
                53: 'Moderate drizzle',
                55: 'Dense drizzle',
                61: 'Slight rain',
                63: 'Moderate rain',
                65: 'Heavy rain',
                71: 'Slight snow',
                73: 'Moderate snow',
                75: 'Heavy snow',
                77: 'Snow grains',
                80: 'Slight rain showers',
                81: 'Moderate rain showers',
                82: 'Violent rain showers',
                85: 'Slight snow showers',
                86: 'Heavy snow showers',
                95: 'Thunderstorm',
                96: 'Thunderstorm with slight hail',
                99: 'Thunderstorm with heavy hail'
            }

            if (!forecast) {
                data.current.conditions = weatherCodes[data.current.weather_code] || 'Unknown';
                return { now: new Date().toString(), current: data.current };
            }

            const days = data.daily.time.map((date, index) => {
                return Object.keys(data.daily).reduce((acc, key) => {
                    acc[key === 'time' ? 'date' : key] = data.daily[key][index];
                    return acc;
                }, { day: new Date(date).toLocaleString(undefined, { weekday: 'short', timeZone: 'UTC' }), conditions: weatherCodes[data.daily.weather_code[index]] || 'Unknown' });
            });
            
            return { now: new Date().toString(), forecast: days }
        }

        async function get_current_time() {
            return { now: new Date().toString() };
        }

        async function get_user_history({ keywords, limit = 3 }) {
            list = (keywords || '').toString().toLowerCase().split(' ');
            const history = JSON.parse(localStorage.getItem('history')) || [];
            const matching = history.filter(h => list.find(k => h.log[0].content.toLowerCase().includes(k.trim())));
            const results = (matching?.length ? matching : history).slice(0, limit).map(h => h.log)
            return {
                description: 'The logs array contains the ' + (matching?.length ? `${matching.length} previous conversations matching the keywords "${keywords}"` : `latest ${results.length} conversations`) + ' of ' + history.length + ' total past conversations with this user.',
                logs: results
            }
        }
        // TOOL FUNCTIONS END


        // Globals. Don't touch.
        let isAvailable = false;
        let isGenerating = false;
        let chatMemory = [];
        let toolCalls = [];
        let tokenAmount = 0;
        let generatingInterval = null;
        let startWaiting = null
        let startGeneration = null;
        let loadedChatID = null;
        let selectedModel = null;
        let generatingModel = null;
        let loadedModels = [];
        let cancelStreaming = false;
        let lastThrottleTime = 0
        let queuedTokens = ''
        let throttleInterval = null
        let attachedFiles = [];
        let blockAutoScrolling = false;

        
        function adjustOffset(value) {
            if (!value) {
                blockAutoScrolling = false;
                document.body.style.removeProperty('--offset');
                setTimeout(() => {
                    if (!chatMemory.length) {
                        document.body.classList.add('new');
                    }
                }, 300);
            } else {
                blockAutoScrolling = document.body.classList.contains('new');
                document.body.style.setProperty('--offset', value);
                if (isAvailable && window.innerWidth <= 768) {
                    document.body.classList.remove('new');
                    setTimeout(() => {
                        window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
                    }, 100);
                }
            }
        }

        function clearMemory() {
          if (isGenerating) return;

          chatMemory = [];
          startWaiting = null;
          loadedChatID = null;
          const messagesDiv = document.getElementById('chatMessages');
          messagesDiv.innerHTML = '';
          clearInterval(generatingInterval);
        }

        async function handleFileUpload(event) {
            const files = event.target.files;

            for (const file of files) {
                if (attachedFiles.find(f => f.name === file.name)) continue;

                if (file.type === 'application/pdf') {
                    try {
                        const text = await extractTextFromPDF(file);
                        
                        attachedFiles.push({
                            name: file.name,
                            text: text,
                            type: 'pdf'
                        });
                    } catch (error) {
                        console.error('Error reading PDF:', error);
                    }
                } else {
                    attachedFiles.push({
                        name: file.name,
                        text: await file.text(),
                        type: file.name.split('.')[1] || 'txt'
                    });
                }
            }
            const attachmentsElem = document.getElementById('fileAttachments');
            appendFileElements(attachedFiles, attachmentsElem);
            event.target.value = '';
        }

        function appendFileElements(files, elem) {
            if (!elem) {
                elem = document.createElement('div');
                elem.className = 'attachments';
            }
            files.forEach(file => {
                const attachment = document.createElement('div');
                attachment.className = 'attachment ' + file.type;
                attachment.innerHTML = `
                    <span class="type">${file.type}</span>
                    <span class="name">${file.name}</span>
                    <button onclick="removeFile('${file.name}')">&times;</button>
                `;
                elem.appendChild(attachment);
            })

            return elem;
        }

        async function extractTextFromPDF(file) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
            
            return text;
        }

        function removeFile(filename) {
            attachedFiles = attachedFiles.filter(f => f.name !== filename);
            const fileAttachments = document.getElementById('fileAttachments');
            const attachment = Array.from(fileAttachments.children)
                .find(el => el.querySelector('.name').textContent === filename);
            if (attachment) {
                fileAttachments.removeChild(attachment);
            }
        }

        function getUserInfo() {
            return (window.USER_INFO ? '\nHere is some information the user would like you to know in general. Never ever reference it directly in your response but use it to relate better with the user!\n "' + window.USER_INFO + '"' : '') + '\n\n'
        }

        async function sendMessage() {
            if (!isAvailable) return;

            if (isGenerating) {
                cancelStreaming = true;
                return;
            }

            const inputElem = document.getElementById('userInput');
            inputElem.blur();

            let messageText = inputElem.value.trim();

            if (!messageText && !attachedFiles.length) return;

            if (!chatMemory.length) {
                clearMemory();
            }

            document.body.classList.remove('new');

            const prompt = {
                role: 'user',
                content: messageText,
                files: attachedFiles
            };

            const systemPrompt = {
                role: "system",
                content: (window.SYSTEM_PROMPT || '') + getUserInfo()
                    
            };

            const messages = [...chatMemory, prompt];

            let tokenLength = JSON.stringify(systemPrompt).length + 40;
            for (let i = messages.length - 1; i >= 0; i--) {
                tokenLength += JSON.stringify(messages[i]).length + 1;
                if (tokenLength > MAX_TOKENS) {
                    while (i >= 0) {
                        messages.shift();
                        i--;
                    }
                    continue;
                }
            }

            if (!messages.length) {
                appendMessage('Prompt size is too large.', 'system')
                return;
            }

            appendMessage(messageText, 'user', attachedFiles);

            userInput.value = '';
            userInput.style.height = 'auto'
            attachedFiles = [];
            document.getElementById('fileAttachments').innerHTML = '';

            chatMemory.push(prompt);

            appendMessageChunk('');

            await streamResponse([systemPrompt, ...messages], selectedModel, function (agentResponse) {
                if (!agentResponse || cancelStreaming) return;

                chatMemory.push({
                    role: 'assistant',
                    content: agentResponse,
                    status: statusString()
                });
                
                const history = JSON.parse(localStorage.getItem('history')) || []
                const index = history.findIndex(h => h.id === loadedChatID);

                const newID = new Date().getTime().toString();
                const chat = {
                    id: newID,
                    log: chatMemory
                };

                if (index >= 0) {
                    history[index] = chat;
                } else {
                    history.unshift(chat)
                }
                
                try {
                    while (history.length > 0 && JSON.stringify(history).length >= MAX_STORAGE_CHARS) {
                        history.pop();
                    }
                    const toStore = JSON.stringify(history);
                    localStorage.setItem('history', toStore)
                    console.log(`Saved ${toStore.length} characters to history.`)
                } catch (error) {
                    console.error('Error:', error)
                }

                appendHistoryItem(chat, loadedChatID || newID);

                loadedChatID = newID;
            });
        }

        async function streamResponse(messages, model, postFunc) {
            const ask = document.getElementById('ask');
            ask.classList.add('stop');

            tokenAmount = 0;
            startGeneration = null;
            startWaiting = new Date();
            isGenerating = true;
            generatingInterval = setInterval(scrollToEnd, 200);
            cancelStreaming = false;
            generatingModel = model;
            toolCalls = [];

            let agentResponse = ''

            try {
                agentResponse = await completionsCall(messages, model, TOOLS);

                while (toolCalls.length && !cancelStreaming) {
                    messages.push({
                        role: 'assistant',
                        content: agentResponse,
                        tool_calls: toolCalls.slice()
                    });

                    for (const tc of toolCalls) {
                        if (typeof window[tc.function.name] === 'function') {
                            const args = tc.function.arguments ? JSON.parse(tc.function.arguments) : undefined;

                            try {
                                const result = await window[tc.function.name](args);
                                console.log(`Tool call executed: ${tc.function.name}`, args, result);

                                messages.push({
                                    role: 'tool',
                                    content: JSON.stringify(result),
                                    tool_call_id: tc.id
                                });
                            } catch (e) {
                                console.error(`Tool call error: ${tc.function.name}`, args, e);
                            }
                        }
                    }

                    toolCalls = [];
                    agentResponse += await completionsCall(messages, model);
                }
            } catch (error) {
                console.error('Error:', error);
                appendMessage('There was a network error.', 'system');
            } finally {
                postFunc?.(agentResponse);
                
                isGenerating = false;
                const ask = document.getElementById('ask');
                ask.classList.remove('stop');
                setTimeout(() => clearInterval(generatingInterval), 150);
            }
        }

        async function completionsCall (messages, model, toolList) {
            let agentResponse = '';

            const response = await fetch(window.API_URL + '/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${window.API_KEY}`
                },
                body: JSON.stringify({
                    model,
                    messages: messages.map(m => {
                        const n = {
                            role: m.role,
                            content: m.content,
                            tool_call_id: m.tool_call_id,
                            tool_calls: m.tool_calls
                        }
                        if (m.files?.length) {
                            let i = 1;
                            n.content = `${n.content}\n\n${m.files.length} file(s) are attached for context:\n${m.files.map(f => `[File ${i++}: ${f.name}]:\n${f.text}`).join('\n\n')}`;
                        }
                        return n;
                    }),
                    tools: toolList,
                    stream: true,
                    max_tokens: MAX_TOKENS,
                    temperature: TEMPERATURE
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let thinking = false;

            while (true) {
                const {done, value} = await reader.read();
                if (done || cancelStreaming) break;

                const chunk = decoder.decode(value);
                buffer += chunk;

                while (buffer.includes('\n')) {
                    const index = buffer.indexOf('\n');
                    const line = buffer.substring(0, index + 1);
                    buffer = buffer.substring(index + 1);

                    try {
                        if (line.match(/^Data: \{.*\}/i)) {
                            const data = JSON.parse(line.substring(6));
                            const delta = data.choices[0].delta;

                            if (!tokenAmount && !startGeneration) {
                                startGeneration = new Date();
                            }
                            tokenAmount++;

                            if (delta.content) {
                                if(delta.content === '<think>') {
                                    thinking = true;
                                } else if (delta.content === '</think>') {
                                    thinking = false;
                                }
                                agentResponse += delta.content;
                                throttleAppendMessageChunk(delta.content);
                            }
                            else if (!thinking && delta.tool_calls?.length) {
                                delta.tool_calls.forEach(tc => {
                                    if (toolCalls.length <= tc.index) {
                                        toolCalls.push({
                                            id: '',
                                            type: 'function',
                                            function: { name: '', arguments: '' }
                                        });
                                    }
                                    const call = toolCalls[tc.index];
                                    call.id += tc.id || '';
                                    call.function.name += tc.function.name || '';
                                    call.function.arguments += tc.function.arguments || '';
                                });
                            }
                        }
                    } catch (e) {
                        console.error('JSON Parse Error:', e.message, 'Data:', line);
                    }
                }
            }
            throttleAppendMessageChunk('\n ');
            return agentResponse + '\n ';
        }

        function appendMessage(text, sender, files, status) {
            if (isGenerating) return;

            const messagesDiv = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${sender === 'user' ? 'user-message' : sender === 'system' ? 'system-message' : 'ai-message'}`;
            const content = document.createElement('div');
            content.innerHTML = markdownToHtml(text);
            if (files?.length) {
                content.appendChild(appendFileElements(files));
            }
            message.appendChild(content);
            if (status) {
                const statusElem = document.createElement('div');
                statusElem.className = 'status';
                statusElem.innerHTML = status;
                message.appendChild(statusElem);
            }
            messagesDiv.appendChild(message);
            scrollToEnd(true);
        }

        function appendMessageChunk(token) {
            const messagesDiv = document.getElementById('chatMessages');
            let message = messagesDiv.lastElementChild;

            if (!message || !message.classList.contains('ai-message')) {
                message = document.createElement('div');
                message.className = 'message ai-message';
                message.dataset.raw = ''
                const content = document.createElement('div');
                const status = document.createElement('div');
                status.className = 'status';
                message.appendChild(content);
                message.appendChild(status);
                messagesDiv.appendChild(message);
            }

            message.dataset.raw += token;
            message.firstElementChild.innerHTML = markdownToHtml(message.dataset.raw);
            hljs.highlightAll();
        }

        function throttleAppendMessageChunk (token) {
          const now = Date.now()
          const timeSinceLastCall = now - lastThrottleTime
          queuedTokens += token || ''

          if (timeSinceLastCall < 80) {
            throttleInterval = setTimeout(throttleAppendMessageChunk, timeSinceLastCall)
            return
          }

          clearTimeout(throttleInterval)
          appendMessageChunk(queuedTokens)
          queuedTokens = ''
          lastThrottleTime = now
        }

        function markdownToHtml(markdown) {
            const html = marked.parse(markdown, {
              breaks: true,
              gfm: true,
              headerIds: false,
              mangle: false
            })

            return html.trim()
        }

        function scrollToEnd(noStatus) {
            const messagesDiv = document.getElementById('chatMessages');

            if (!blockAutoScrolling && (messagesDiv.scrollHeight < window.innerHeight || window.scrollY + window.innerHeight > messagesDiv.scrollHeight || noStatus)) {
                window.scrollTo({ top: Math.max(messagesDiv.scrollHeight, window.innerHeight), behavior: 'smooth' });
            }

            if (!noStatus && startWaiting) {
                const messagesDiv = document.getElementById('chatMessages');
                let status = messagesDiv.lastElementChild?.lastElementChild;
                if (!status) return;
                status.innerHTML = statusString();
            }
        }

        function statusString () {
            const wait = ((startGeneration || new Date()).getTime() - startWaiting.getTime()) / 1000;
            const parts = [];
            if (tokenAmount > 0) {
                const sec = (new Date().getTime() - startGeneration.getTime()) / 1000;
                parts.push(formatDuration(wait + sec));
                parts.push((tokenAmount / sec).toFixed(2) + ' tok/s &#183; ' + tokenAmount + ' token');
                parts.push(formatDuration(wait) + ' to first token');
            } else if (isGenerating) {
                parts.push(formatDuration(wait));
                parts.push('Waiting for first token ...');
            }
            parts.push(generatingModel)
            return parts.join(' &#183; ')
        }

        function formatDuration (seconds) {
            const ms = Math.floor((seconds % 1) * 10).toFixed(0);
            const s = Math.floor(seconds % 60);
            const m = Math.floor((seconds / 60) % 60);
            const h = Math.floor(seconds / 3600);

            const parts = [];
            
            if (h > 0) parts.push(`${h}h `);
            if (m > 0) parts.push(`${m}m `);
            parts.push(`${s}.`);
            parts.push(`${ms}s`);

            return parts.join('');
        }

        async function loadModels() {
          isAvailable = false;
          
          const ask = document.getElementById('ask');
          ask.disabled = true

          const select = document.getElementById('modelSection');
          select.innerHTML = '';
          selectedModel = '';

          try {
            const response = await fetch(window.API_URL + '/v1/models', {
              headers: {
                'Authorization': `Bearer ${window.API_KEY}`,
                'Content-Type': 'application/json'
              }
            });
            const models = await response.json();

            if (!models.data.length) {
                clearMemory()
                appendMessage('There are no models loaded.', 'system');
                return;
            }

            loadedModels = models.data;

            loadedModels.forEach(m => {
              const onclick = function (e) {
                selectedModel = m.id;
                Array.from(document.getElementById('modelSection').children).forEach(n => n.classList[n.dataset.id === m.id ? 'add' : 'remove']('checked'));
              };
              const option = document.createElement('button');
              option.dataset.id = m.id;
              option.textContent = m.name || m.id;
              option.onclick = onclick;
              select.appendChild(option);

              if (!selectedModel || DEFAULT_MODELS.includes(m.id)) {
                onclick();
              }
            });

            isAvailable = true;
            ask.disabled = false;

            sayHello();
          } catch (error) {
            console.error(error)
            clearMemory()
            appendMessage('Configure a valid OpenAI v1 compatible API in the server settings.', 'system');
          }
        }
        
        function sayHello () {
            if (!isAvailable || isGenerating) return;

            clearMemory();

            document.body.classList.add('new');

            const model = loadedModels.find(m => DEFAULT_MODELS.includes(m.id))?.id

            if (model) {
                let content = 'You\'re a professional entertainer. Say hello and ask how to help. It\'s okay to be mildly cynical. You must always use less than 30 words!';
                const history = JSON.parse(localStorage.getItem('history')) || [];
                if (history.length) {
                    content += '\nHere are some previous user chat logs with you that you could reference on the occasion:'
                    let i = 1;
                    history.slice(0, 10).forEach(h => {
                        content += `\n${1}.: ${h.log[0].content.substring(0, 255)}`;
                    })
                }
                streamResponse([{
                    role: 'user',
                    content: content + getUserInfo(),
                }], model);
            } else {
                appendMessage(DEFAULT_GREETING);

                const ask = document.getElementById('ask');
                ask.disabled = false;
            }
        }

        function enableClearHistory() {
            if (document.getElementById('clearHistory')) return;

            const select = document.getElementById('historyMenu');
            const option = document.createElement('button');
            option.id = 'clearHistory';
            option.textContent = 'Clear history';
            option.onclick = function () {
                if (!confirm('Are you sure?\nI won\'t be able reference your previous queries anymore. *sadface*')) return;
                try {
                    localStorage.setItem('history', '[]');
                    select.innerHTML = '';
                } catch (error) {
                    console.error('Error:', error)
                }
            }
            select.appendChild(option);
        }

        function loadHistory () {
            const history = JSON.parse(localStorage.getItem('history')) || [];
            history.forEach(chat => appendHistoryItem(chat))
            
            if (!history.length) return;

            enableClearHistory();
        }

        function appendHistoryItem(chat, replaceID) {
            const select = document.getElementById('historyMenu');
            if (replaceID) {
                Array.from(select.children).forEach(c => {
                    if (c.dataset.id === replaceID) {
                        select.removeChild(c);
                    }
                })
                enableClearHistory();
            }
            const option = document.createElement('button');
            option.dataset.id = chat.id;
            let content = chat.log[0].content;
            if (!content && chat.log[0].files?.length) {
                content = chat.log[0].files[0].type.toUpperCase() + ': ' + chat.log[0].files[0].name;
            }
            option.textContent = content;
            option.onclick = () => loadHistoryLog(chat);
            select[replaceID ? 'prepend' : 'appendChild'](option);
        }

        function loadHistoryLog (chat) {
            if (isGenerating) {
                cancelStreaming = true;
                return
            };
            if (loadedChatID === chat.id) return;
            closeMenu();
            clearMemory();
            document.body.classList.remove('new');
            loadedChatID = chat.id;
            chatMemory = chat.log;
            chatMemory.forEach(l => {
                appendMessage(l.content, l.role, l.files, l.status);
            });
            hljs.highlightAll();
        }

        function addThinkingAndKatexSupport () {
            const markedOptions = {
                extensions: [{
                    name: 'think',
                    level: 'block',
                    start(src) {
                        return src.indexOf('<think>');
                    },
                    tokenizer(src) {
                        const match = src.match(/^<think>([\s\S]*?)(<\/think>|\[TOOL_REQUEST$)/);
                        if (match) {
                            return {
                                type: 'think',
                                raw: match[0],
                                text: match[1].trim(),
                                tokens: this.lexer.blockTokens(match[1].trim())
                            };
                        }
                        return false;
                    },
                    renderer(token) {
                        return `<div class="think">${marked.parser(token.tokens)}</div>`;
                    }
                }, {
                    name: 'katexBlock',
                    level: 'block',
                    start(src) {
                        return src.indexOf('\\\[');
                    },
                    tokenizer(src) {
                        const match = src.match(/^\\\[([\s\S]+?)\\\]/);
                        if (match) {
                            const raw = match[0];
                            const text = katex?.renderToString(match[1].replace(/\\\\/g, '\\'), { displayMode: true }) || match[0];
                            return {
                                type: 'katexBlock',
                                raw,
                                text
                            };
                        }
                        return false;
                    },
                    renderer(token) {
                        return `<p>${token.text}</p>`;
                    }
                }, {
                    name: 'katexDollarBlock',
                    level: 'block',
                    start(src) {
                        return src.indexOf('$$');
                    },
                    tokenizer(src) {
                        const match = src.match(/^\$\$([\s\S]+?)\$\$(\s|$)/);
                        if (match) {
                            const raw = match[0];
                            const text = katex?.renderToString(match[1].replace(/\\\\/g, '\\'), { displayMode: true }) || match[0];
                            return {
                                type: 'katexDollarBlock',
                                raw,
                                text
                            };
                        }
                        return false;
                    },
                    renderer(token) {
                        return `<p>${token.text}</p>`;
                    }
                }, {
                    name: 'katexInline',
                    level: 'inline',
                    start(src) {
                        return src.indexOf('\\\(');
                    },
                    tokenizer(src) {
                        const match = src.match(/^\\\(([\s\S]+?)\\\)/);
                        if (match) {
                            const raw = match[0];
                            const text = katex?.renderToString(match[1].replace(/\\\\/g, '\\'), { displayMode: false }) || match[0];
                            return {
                                type: 'katexInline',
                                raw,
                                text
                            };
                        }
                        return false;
                    },
                    renderer(token) {
                        return token.text;
                    }
                }, {
                    name: 'katexDollarInline',
                    level: 'inline',
                    start(src) {
                        return src.indexOf('$');
                    },
                    tokenizer(src) {
                        const match = src.match(/^\$([\s\S]+?)\$([\s.,'"]|$)/);
                        if (match) {
                            const raw = match[0];
                            const text = katex?.renderToString(match[1].replace(/\\\\/g, '\\'), { displayMode: false }) + match[2] || match[0];
                            return {
                                type: 'katexDollarInline',
                                raw,
                                text
                            };
                        }
                        return false;
                    },
                    renderer(token) {
                        return token.text;
                    }
                }],
                hooks: {
                    postprocess(html) {
                        return html
                            .replace(/(<table>[\s\S]*?<\/table>)/g, '<div class="table">$1</div>')
                            .replace(/(<pre><code(?: class="language-(\S+)")?>[\s\S]*?<\/code><\/pre>)/g, '<div class="code">$1<div class="meta"><span>$2</span><button class="copy" /></div></div>')
                            .replace(/\[(END_)?TOOL_(REQUEST|RESULT)\]?/g, '');
                    }
                }
            };

            marked.use(markedOptions);
        }

        function startNew() {
            closeMenu();
            sayHello();
        }

        function openMenu(menu) {
            closeMenu(menu);
            document.getElementById(menu).classList.toggle('open')
        }

        function closeMenu(menu) {
            document.querySelectorAll('.menu').forEach(e => e.id !== menu && e.classList.remove('open'))
        }

        function loadSettings() {
            document.querySelectorAll('.menu .setting').forEach(i => {
                try {
                    i.value = localStorage.getItem(i.id) || i.dataset.default;
                } catch(e) {
                    i.value = i.dataset.default
                }
                window[i.id] = i.value;
            });
        }

        function saveSetting(id) {
            const val = document.getElementById(id).value.trim()

            if (val === window[id]) return;

            window[id] = val
            try {
                localStorage.setItem(id, val);
            } catch(error) {
                console.error('Error: ', error);
            }
            loadModels();
        }

        window.addEventListener('DOMContentLoaded', function () {
            addThinkingAndKatexSupport();
            loadSettings();
            loadModels();
            loadHistory();

            const textarea = document.getElementById('userInput');
            
            textarea.addEventListener('input', function () {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(200, textarea.scrollHeight) + 'px';
            })
            
            textarea.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.addEventListener('click', function (e) {
                const thoughtsElement = e.target.closest('.think');
                if (thoughtsElement) {
                    thoughtsElement.classList.toggle('expanded');
                }

                const userElement = e.target.closest('.user-message')
                if (userElement) {
                    document.getElementById('userInput').value = userElement.innerText;
                }

                const inputElement = e.target.closest('.input-container')
                const chatElement = e.target.closest('.chat-container')
                if (inputElement || chatElement) {
                    closeMenu();
                }

                if (e.target.className === 'copy') {
                    const textToCopy = e.target.closest('.code').children[0].children[0].innerText;
                    navigator.clipboard.writeText(textToCopy)
                        .catch((error) => {
                            console.error("Error:", error);
                        });
                }
            });

            window.addEventListener('scroll', function () {
                const scrollButton = document.getElementById('scrolldown')
                const isAtBottom = window.innerHeight + window.scrollY >= document.documentElement.scrollHeight - 150
                scrollButton.style.display = isAtBottom ? 'none' : 'block'
            })

            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            })
            document.body.classList.add(window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'embedded');
        };
    </script>
</body>
</html>
